<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warframe Vault Checker</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <div id="scene-container"></div>
    <div class="dots-pattern dots-left"></div>
    <div class="dots-pattern dots-right"></div>
    
    <div id="app">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search relic or item..." autocomplete="off">
            <button onclick="performSearch()">Search</button>
            <div id="suggestions"></div>
        </div>
        
        <div class="left-panel">
            <h3>Details</h3>
            <div id="result"></div>
        </div>
        
        <div class="center-area"></div>
        
        <div class="right-panel">
            <div class="relics-header">
                <button id="activeRelicsBtn" class="toggle-btn active" onclick="toggleRelicsView('active')">Active Relics</button>
                <button id="vaultedRelicsBtn" class="toggle-btn" onclick="toggleRelicsView('vaulted')">Vaulted Relics</button>
            </div>
            <div id="activeRelicsList"></div>
        </div>
    </div>

    <footer class="footer">
        <p>Data sourced from <a href="https://warframe.fandom.com/wiki/Void_Relic" target="_blank" rel="noopener noreferrer">Warframe Wiki</a></p>
    </footer>

    <!-- YouTube Music Player -->
    <div id="music-player">
        <div id="player-header">
            <span>MUSIC</span>
            <div class="player-controls">
                <button id="play-pause-toggle" onclick="togglePlayPause()" title="Play/Pause">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                </button>
                <button id="audio-toggle" onclick="toggleAudio()" title="Mute/Unmute">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                    </svg>
                </button>
                <button id="expand-toggle" onclick="toggleExpand()" title="Show/Hide Video">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>
        </div>
        <div id="player-container" style="display: none;">
            <div id="youtube-player"></div>
        </div>
    </div>

    <script type="module">
        import { init3DScene } from './scene3d.js';
        init3DScene();
    </script>
    <script>
        let relicDatabase = {};
        let vaultedRelics = [];
        let activeRelics = [];
        let itemDatabase = {}; // Mappa item->reliquie
        let currentRelicsView = 'active'; // 'active' o 'vaulted'
        let youtubePlayer = null;
        let isMuted = localStorage.getItem('musicMuted') === 'true' || false;
        let isExpanded = localStorage.getItem('musicExpanded') === 'true' || false;
        let isPlaying = false; // Parte da false, poi diventa true quando inizia

        // YouTube API ready callback
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', {
                videoId: 'yPKo04oNQ9k',
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'loop': 1,
                    'playlist': 'yPKo04oNQ9k',
                    'modestbranding': 1,
                    'rel': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            // Imposta volume basso
            event.target.setVolume(15);
            
            // Ripristina stato mute da localStorage e applica
            if (isMuted) {
                event.target.mute();
            }
            
            // Avvia SEMPRE il video al caricamento, indipendentemente dallo stato salvato
            setTimeout(() => {
                event.target.playVideo();
                isPlaying = true;
            }, 100);
            
            // Ripristina stato espansione
            if (isExpanded) {
                const container = document.getElementById('player-container');
                const button = document.getElementById('expand-toggle');
                container.style.display = 'block';
                button.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                `;
            }
        }

        function onPlayerStateChange(event) {
            const button = document.getElementById('play-pause-toggle');
            // YT.PlayerState.PLAYING = 1, YT.PlayerState.PAUSED = 2
            if (event.data === 1) { // Playing
                isPlaying = true;
                button.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                `;
            } else if (event.data === 2 || event.data === 5) { // Paused or Cued
                isPlaying = false;
                button.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                `;
            }
        }

        // Toggle play/pause
        function togglePlayPause() {
            const button = document.getElementById('play-pause-toggle');
            if (youtubePlayer && youtubePlayer.getPlayerState) {
                if (isPlaying) {
                    youtubePlayer.pauseVideo();
                    isPlaying = false;
                    button.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    `;
                } else {
                    youtubePlayer.playVideo();
                    isPlaying = true;
                    button.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                    `;
                }
            }
        }

        // Toggle video visibility
        function toggleExpand() {
            const container = document.getElementById('player-container');
            const button = document.getElementById('expand-toggle');
            isExpanded = !isExpanded;
            
            // Salva preferenza
            localStorage.setItem('musicExpanded', isExpanded);
            
            if (isExpanded) {
                container.style.display = 'block';
                button.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                `;
            } else {
                container.style.display = 'none';
                button.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                `;
            }
        }

        // Toggle audio mute/unmute
        function toggleAudio() {
            const button = document.getElementById('audio-toggle');
            if (youtubePlayer && youtubePlayer.isMuted !== undefined) {
                if (isMuted) {
                    youtubePlayer.unMute();
                    isMuted = false;
                    localStorage.setItem('musicMuted', 'false');
                    button.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                        </svg>
                    `;
                } else {
                    youtubePlayer.mute();
                    isMuted = true;
                    localStorage.setItem('musicMuted', 'true');
                    button.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <line x1="23" y1="9" x2="17" y2="15"></line>
                            <line x1="17" y1="9" x2="23" y2="15"></line>
                        </svg>
                    `;
                }
            }
        }

        // Ripristina icona mute all'avvio
        window.addEventListener('DOMContentLoaded', () => {
            if (isMuted) {
                const button = document.getElementById('audio-toggle');
                button.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <line x1="23" y1="9" x2="17" y2="15"></line>
                        <line x1="17" y1="9" x2="23" y2="15"></line>
                    </svg>
                `;
            }
        });

        // Load YouTube API
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // Load data on startup
        window.addEventListener('DOMContentLoaded', async () => {
            await loadRelicData();
        });

        async function loadRelicData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading"> Loading data from Warframe Wiki...</div>';

            try {
                // Use MediaWiki API to get raw content
                const url = 'https://warframe.fandom.com/api.php?action=query&format=json&prop=revisions&titles=Module:Void/data&rvprop=content&rvslots=main&origin=*';
                
                const response = await fetch(url);
                const data = await response.json();
                
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                const content = pages[pageId].revisions[0].slots.main['*'];
                                
                // Parse Lua content
                parseRelicData(content);
                
                resultDiv.innerHTML = '';
                displayActiveRelics();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Loading error: ${error.message}</div>`;
                console.error(error);
            }
        }

        function parseRelicData(luaContent) {
            // Trova RelicData usando regex
            const relicDataRegex = /RelicData\s*=\s*\{([\s\S]*?)\n\}\n/;
            const match = luaContent.match(relicDataRegex);
            
            if (!match) {
                throw new Error('RelicData not found');
            }
            
            const relicSection = match[1];

            // Pattern to match each complete relic
            const relicRegex = /\["([^"]+)"\]\s*=\s*\{([\s\S]*?)\n\t\},?/g;
            let relicMatch;
            let count = 0;
            
            while ((relicMatch = relicRegex.exec(relicSection)) !== null) {
                const relicName = relicMatch[1];
                const relicBody = relicMatch[2];
                
                // Skip Requiem
                if (relicName.startsWith('Requiem')) continue;
                
                // Extract fields
                const tierMatch = relicBody.match(/Tier\s*=\s*"([^"]+)"/);
                if (!tierMatch) continue;
                
                const tier = tierMatch[1];
                if (!['Lith', 'Meso', 'Neo', 'Axi'].includes(tier)) continue;
                
                const vaultedMatch = relicBody.match(/Vaulted\s*=\s*"([^"]+)"/);
                const introducedMatch = relicBody.match(/Introduced\s*=\s*"([^"]+)"/);
                
                // Extract drops
                const dropsMatch = relicBody.match(/Drops\s*=\s*\{([\s\S]*?)\n\t\t\}/);
                const drops = [];
                
                if (dropsMatch) {
                    const dropsContent = dropsMatch[1];
                    const dropRegex = /\{\s*Item\s*=\s*"([^"]+)"[^}]*Part\s*=\s*"([^"]*)"[^}]*Rarity\s*=\s*"([^"]+)"[^}]*\}/g;
                    let dropMatch;
                    
                    while ((dropMatch = dropRegex.exec(dropsContent)) !== null) {
                        drops.push({
                            Item: dropMatch[1],
                            Part: dropMatch[2],
                            Rarity: dropMatch[3]
                        });
                    }
                }
                
                relicDatabase[relicName] = {
                    Name: relicName,
                    Tier: tier,
                    Introduced: introducedMatch ? introducedMatch[1] : '',
                    Vaulted: vaultedMatch ? vaultedMatch[1] : null,
                    Drops: drops
                };
                
                // Aggiungi al database degli item
                drops.forEach(drop => {
                    const itemKey = `${drop.Item}${drop.Part ? ' - ' + drop.Part : ''}`;
                    if (!itemDatabase[itemKey]) {
                        itemDatabase[itemKey] = [];
                    }
                    itemDatabase[itemKey].push({
                        relicName: relicName,
                        rarity: drop.Rarity,
                        vaulted: vaultedMatch ? vaultedMatch[1] : null
                    });
                });
                
                if (vaultedMatch) {
                    vaultedRelics.push(relicName);
                } else {
                    activeRelics.push(relicName);
                }
                
                count++;
            }
            
        }

        function performSearch() {
            const input = document.getElementById('searchInput').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!input) {
                resultDiv.innerHTML = '<div class="error">Enter a relic name or item</div>';
                return;
            }
            
            // Check if database is loaded
            if (Object.keys(relicDatabase).length === 0) {
                resultDiv.innerHTML = '<div class="error">Please wait for database loading...</div>';
                return;
            }
            
            // Cerca prima nelle reliquie
            let relicKey = Object.keys(relicDatabase).find(key => 
                key.toLowerCase() === input.toLowerCase()
            );
            
            if (!relicKey) {
                relicKey = Object.keys(relicDatabase).find(key => 
                    key.toLowerCase().includes(input.toLowerCase())
                );
            }
            
            // Se trovata una reliquia, mostrala
            if (relicKey) {
                const relic = relicDatabase[relicKey];
                displayRelicDetails(relic);
                return;
            }
            
            // Altrimenti cerca negli item
            searchItem(input);
        }
        
        function searchRelic() {
            performSearch();
        }
        
        function searchItem(input) {
            const resultDiv = document.getElementById('result');
            const inputLower = input.toLowerCase();
            
            // Cerca item che contengono la stringa
            const matchingItems = Object.keys(itemDatabase).filter(item => 
                item.toLowerCase().includes(inputLower)
            );
            
            if (matchingItems.length === 0) {
                resultDiv.innerHTML = `<div class="error">Relic or item "${input}" not found</div>`;
                return;
            }
            
            // Se c'è un match esatto, usa quello, altrimenti usa il primo match
            let selectedItem = matchingItems.find(item => 
                item.toLowerCase() === inputLower
            ) || matchingItems[0];
            
            displayItemDetails(selectedItem);
        }
        
        function displayItemDetails(itemName) {
            const resultDiv = document.getElementById('result');
            const relics = itemDatabase[itemName];
            
            // Controlla se c'è almeno una reliquia attiva
            const hasActiveRelic = relics.some(r => !r.vaulted);
            const itemStatus = hasActiveRelic 
                ? `<span class="active">ACTIVE</span>`
                : `<span class="vaulted">VAULTED</span>`;
            
            let html = `
                <div class="result">
                    <h2>${itemName}</h2>
                    <p><strong>Status:</strong> ${itemStatus}</p>
                    <div class="relic-details">
                        <h3>Found in relics:</h3>
                        <ul class="drop-list">
            `;
            
            // Ordina le reliquie per tier e poi per nome
            const sortedRelics = [...relics].sort((a, b) => {
                const tierOrder = { 'Lith': 1, 'Meso': 2, 'Neo': 3, 'Axi': 4 };
                const tierA = relicDatabase[a.relicName]?.Tier || '';
                const tierB = relicDatabase[b.relicName]?.Tier || '';
                
                if (tierOrder[tierA] !== tierOrder[tierB]) {
                    return tierOrder[tierA] - tierOrder[tierB];
                }
                
                return a.relicName.localeCompare(b.relicName);
            });
            
            sortedRelics.forEach(relicInfo => {
                const rarityClass = relicInfo.rarity.toLowerCase();
                const vaultStatus = relicInfo.vaulted 
                    ? `<span class="vaulted">VAULTED</span>`
                    : `<span class="active">ACTIVE</span>`;
                
                html += `
                    <li class="drop-item ${rarityClass}">
                        <div class="item-relic-info">
                            <span class="relic-name-link" onclick="selectAndSearch('${relicInfo.relicName}')">
                                ${relicInfo.relicName}
                            </span>
                            <span class="relic-rarity">(${relicInfo.rarity})</span>
                            <span class="relic-status">${vaultStatus}</span>
                        </div>
                    </li>
                `;
            });
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        function displayRelicDetails(relic) {
            const resultDiv = document.getElementById('result');
            const status = relic.Vaulted 
                ? `<span class="vaulted">VAULTED</span> (since ${relic.Vaulted})`
                : `<span class="active">ACTIVE</span>`;
            
            let html = `
                <div class="result">
                    <h2>${relic.Name}</h2>
                    <p><strong>Tier:</strong> ${relic.Tier}</p>
                    <p><strong>Status:</strong> ${status}</p>
                    <p><strong>Introduced:</strong> ${relic.Introduced}</p>
                    
                    <div class="relic-details">
                        <div class="content-header">
                            <h3>Content:</h3>
                            <div class="help-container">
                                <span class="help-icon">?</span>
                                <div class="drop-guide-tooltip">
                                    <p><strong>Drop Chances:</strong></p>
                                    <div class="refinement-section">
                                        <p class="refinement-title">Intact:</p>
                                        <p>Common: 25.33% | Uncommon: 11% | Rare: 2%</p>
                                    </div>
                                    <div class="refinement-section">
                                        <p class="refinement-title">Exceptional:</p>
                                        <p>Common: 23.33% | Uncommon: 13% | Rare: 4%</p>
                                    </div>
                                    <div class="refinement-section">
                                        <p class="refinement-title">Flawless:</p>
                                        <p>Common: 20% | Uncommon: 17% | Rare: 6%</p>
                                    </div>
                                    <div class="refinement-section">
                                        <p class="refinement-title">Radiant:</p>
                                        <p>Common: 16.67% | Uncommon: 20% | Rare: 10%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <ul class="drop-list">
            `;
            
            relic.Drops.forEach(drop => {
                const rarityClass = drop.Rarity.toLowerCase();
                const itemName = `${drop.Item}${drop.Part ? ' - ' + drop.Part : ''}`;
                
                html += `
                    <li class="drop-item ${rarityClass}" onclick="selectAndSearchItem('${itemName.replace(/'/g, "\\'")}')">
                        <span class="item-name-underline">${itemName}</span> 
                        <small>(${drop.Rarity})</small>
                    </li>
                `;
            });
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        function displayActiveRelics() {
            const listDiv = document.getElementById('activeRelicsList');
            const relicsToShow = currentRelicsView === 'active' ? activeRelics : vaultedRelics;
            
            if (relicsToShow.length === 0) {
                listDiv.innerHTML = '<p style="color: #999;">Loading...</p>';
                return;
            }
            
            let html = '<div class="relic-list">';
            relicsToShow.forEach(relicName => {
                html += `<div class="relic-name" onclick="selectAndSearch('${relicName}')">${relicName}</div>`;
            });
            html += '</div>';
            
            listDiv.innerHTML = html;
        }
        
        function toggleRelicsView(view) {
            currentRelicsView = view;
            
            // Aggiorna i pulsanti
            document.getElementById('activeRelicsBtn').classList.toggle('active', view === 'active');
            document.getElementById('vaultedRelicsBtn').classList.toggle('active', view === 'vaulted');
            
            // Aggiorna la lista
            displayActiveRelics();
        }

        function selectAndSearch(relicName) {
            document.getElementById('searchInput').value = relicName;
            searchRelic();
        }
        
        function selectAndSearchItem(itemName) {
            document.getElementById('searchInput').value = itemName;
            performSearch();
        }

        // Autocomplete
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const value = e.target.value.toLowerCase();
            const suggestionsDiv = document.getElementById('suggestions');
            
            if (value.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Cerca sia nelle reliquie che negli item
            const relicMatches = Object.keys(relicDatabase)
                .filter(name => name.toLowerCase().includes(value))
                .slice(0, 5)
                .map(name => {
                    const relic = relicDatabase[name];
                    const status = relic.Vaulted ? 'vaulted' : 'active';
                    return { name, type: 'relic', status };
                });
            
            const itemMatches = Object.keys(itemDatabase)
                .filter(name => name.toLowerCase().includes(value))
                .slice(0, 5)
                .map(name => {
                    const hasActiveRelic = itemDatabase[name].some(r => !r.vaulted);
                    const status = hasActiveRelic ? 'active' : 'vaulted';
                    return { name, type: 'item', status };
                });
            
            const matches = [...relicMatches, ...itemMatches].slice(0, 10);
            
            if (matches.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            suggestionsDiv.innerHTML = matches
                .map(match => {
                    const statusBadge = `<span class="${match.status}">${match.status.toUpperCase()}</span>`;
                    return `<div class="suggestion-item" onclick="selectSuggestion('${match.name.replace(/'/g, "\\'")}')"><span class="suggestion-name">${match.name}</span> ${statusBadge}</div>`;
                })
                .join('');
            suggestionsDiv.style.display = 'block';
        });

        function selectRelic(name) {
            document.getElementById('searchInput').value = name;
            document.getElementById('suggestions').style.display = 'none';
            performSearch();
        }
        
        function selectSuggestion(name) {
            document.getElementById('searchInput').value = name;
            document.getElementById('suggestions').style.display = 'none';
            performSearch();
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

        // Press Enter to search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    </script>
</body>
</html>
