<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warframe Vault Checker</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <div id="scene-container"></div>
    <div class="dots-pattern dots-left"></div>
    <div class="dots-pattern dots-right"></div>
    
    <div id="app">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search relic..." autocomplete="off">
            <button onclick="searchRelic()">Search</button>
            <div id="suggestions"></div>
        </div>
        
        <div class="left-panel">
            <h3>Relic Details</h3>
            <div id="result"></div>
        </div>
        
        <div class="center-area"></div>
        
        <div class="right-panel">
            <h3>Active Relics</h3>
            <div id="activeRelicsList"></div>
        </div>
    </div>

    <script type="module">
        import { init3DScene } from './scene3d.js';
        init3DScene();
    </script>
    <script>
        let relicDatabase = {};
        let vaultedRelics = [];
        let activeRelics = [];

        // Load data on startup
        window.addEventListener('DOMContentLoaded', async () => {
            await loadRelicData();
        });

        async function loadRelicData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading"> Loading data from Warframe Wiki...</div>';

            try {
                // Use MediaWiki API to get raw content
                const url = 'https://warframe.fandom.com/api.php?action=query&format=json&prop=revisions&titles=Module:Void/data&rvprop=content&rvslots=main&origin=*';
                
                const response = await fetch(url);
                const data = await response.json();
                
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                const content = pages[pageId].revisions[0].slots.main['*'];
                                
                // Parse Lua content
                parseRelicData(content);
                
                resultDiv.innerHTML = '';
                displayActiveRelics();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Loading error: ${error.message}</div>`;
                console.error(error);
            }
        }

        function parseRelicData(luaContent) {
            // Trova RelicData usando regex
            const relicDataRegex = /RelicData\s*=\s*\{([\s\S]*?)\n\}\n/;
            const match = luaContent.match(relicDataRegex);
            
            if (!match) {
                throw new Error('RelicData not found');
            }
            
            const relicSection = match[1];

            // Pattern to match each complete relic
            const relicRegex = /\["([^"]+)"\]\s*=\s*\{([\s\S]*?)\n\t\},?/g;
            let relicMatch;
            let count = 0;
            
            while ((relicMatch = relicRegex.exec(relicSection)) !== null) {
                const relicName = relicMatch[1];
                const relicBody = relicMatch[2];
                
                // Skip Requiem
                if (relicName.startsWith('Requiem')) continue;
                
                // Extract fields
                const tierMatch = relicBody.match(/Tier\s*=\s*"([^"]+)"/);
                if (!tierMatch) continue;
                
                const tier = tierMatch[1];
                if (!['Lith', 'Meso', 'Neo', 'Axi'].includes(tier)) continue;
                
                const vaultedMatch = relicBody.match(/Vaulted\s*=\s*"([^"]+)"/);
                const introducedMatch = relicBody.match(/Introduced\s*=\s*"([^"]+)"/);
                
                // Extract drops
                const dropsMatch = relicBody.match(/Drops\s*=\s*\{([\s\S]*?)\n\t\t\}/);
                const drops = [];
                
                if (dropsMatch) {
                    const dropsContent = dropsMatch[1];
                    const dropRegex = /\{\s*Item\s*=\s*"([^"]+)"[^}]*Part\s*=\s*"([^"]*)"[^}]*Rarity\s*=\s*"([^"]+)"[^}]*\}/g;
                    let dropMatch;
                    
                    while ((dropMatch = dropRegex.exec(dropsContent)) !== null) {
                        drops.push({
                            Item: dropMatch[1],
                            Part: dropMatch[2],
                            Rarity: dropMatch[3]
                        });
                    }
                }
                
                relicDatabase[relicName] = {
                    Name: relicName,
                    Tier: tier,
                    Introduced: introducedMatch ? introducedMatch[1] : '',
                    Vaulted: vaultedMatch ? vaultedMatch[1] : null,
                    Drops: drops
                };
                
                if (vaultedMatch) {
                    vaultedRelics.push(relicName);
                } else {
                    activeRelics.push(relicName);
                }
                
                count++;
            }
            
        }

        function searchRelic() {
            const input = document.getElementById('searchInput').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!input) {
                resultDiv.innerHTML = '<div class="error"> Enter a relic name</div>';
                return;
            }
            
            // Check if database is loaded
            if (Object.keys(relicDatabase).length === 0) {
                resultDiv.innerHTML = '<div class="error">Please wait for database loading...</div>';
                return;
            }
            
            // Case-insensitive search - exact match first
            let relicKey = Object.keys(relicDatabase).find(key => 
                key.toLowerCase() === input.toLowerCase()
            );
            
            // If no exact match found, search for first containing the text
            if (!relicKey) {
                relicKey = Object.keys(relicDatabase).find(key => 
                    key.toLowerCase().includes(input.toLowerCase())
                );
            }
            
            if (!relicKey) {
                resultDiv.innerHTML = `<div class="error">Relic "${input}" not found in database</div>`;
                return;
            }
            
            const relic = relicDatabase[relicKey];
            displayRelicDetails(relic);
        }

        function displayRelicDetails(relic) {
            const resultDiv = document.getElementById('result');
            const status = relic.Vaulted 
                ? `<span class="vaulted">VAULTED</span> (since ${relic.Vaulted})`
                : `<span class="active">ACTIVE</span>`;
            
            let html = `
                <div class="result">
                    <h2>${relic.Name}</h2>
                    <p><strong>Tier:</strong> ${relic.Tier}</p>
                    <p><strong>Status:</strong> ${status}</p>
                    <p><strong>Introduced:</strong> ${relic.Introduced}</p>
                    
                    <div class="relic-details">
                        <h3>Content:</h3>
                        <ul class="drop-list">
            `;
            
            relic.Drops.forEach(drop => {
                const rarityClass = drop.Rarity.toLowerCase();
                html += `
                    <li class="drop-item ${rarityClass}">
                        ${drop.Item}${drop.Part ? ' - ' + drop.Part : ''} 
                        <small>(${drop.Rarity})</small>
                    </li>
                `;
            });
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        function displayActiveRelics() {
            const listDiv = document.getElementById('activeRelicsList');
            
            if (activeRelics.length === 0) {
                listDiv.innerHTML = '<p style="color: #999;">Loading...</p>';
                return;
            }
            
            let html = '<div class="relic-list">';
            activeRelics.forEach(relicName => {
                html += `<div class="relic-name" onclick="selectAndSearch('${relicName}')">${relicName}</div>`;
            });
            html += '</div>';
            
            listDiv.innerHTML = html;
        }

        function selectAndSearch(relicName) {
            document.getElementById('searchInput').value = relicName;
            searchRelic();
        }

        // Autocomplete
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const value = e.target.value.toLowerCase();
            const suggestionsDiv = document.getElementById('suggestions');
            
            if (value.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const matches = Object.keys(relicDatabase)
                .filter(name => name.toLowerCase().includes(value))
                .slice(0, 10);
            
            if (matches.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            suggestionsDiv.innerHTML = matches
                .map(name => `<div class="suggestion-item" onclick="selectRelic('${name}')">${name}</div>`)
                .join('');
            suggestionsDiv.style.display = 'block';
        });

        function selectRelic(name) {
            document.getElementById('searchInput').value = name;
            document.getElementById('suggestions').style.display = 'none';
            searchRelic();
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

        // Press Enter to search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchRelic();
            }
        });
    </script>
</body>
</html>
